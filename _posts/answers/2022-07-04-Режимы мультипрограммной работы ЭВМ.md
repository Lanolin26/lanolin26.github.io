---
layout: post
title: "Режимы мультипрограммной работы ЭВМ"
categories: sppo-questions pors-questions
---

Надо отметить, что самые первые программисты работали непосредственно за пультом ЭВМ, в своеобразном диалоговом режиме.
Правда, в отличие от персональных ЭВМ, работа была не в привычном нам сейчас графическом или текстовом интерфейсе, а
непосредственно в двоичном коде. Лампочки на пульте ЭВМ высвечивали значения всех регистров (горит – единица, не горит –
ноль), для удобства лампочки разбивались на группы по три или четыре, что позволяло "в уме" работать с машинными словами
в 8-ной или 16-ной системе счисления. Специальная кнопка включала трассировку программы, при этом машина останавливалась
после выполнения каждой команды

Затем из экономических соображений такой режим работы стал нерациональным, так как программисты слишком долго искали и
исправляли ошибки в своих программах или анализировали результаты расчетов, и в это дорогая время ЭВМ простаивала. Тогда
и появился новый, пакетный режим работы (batch mode), и программистов перестали пускать в машинный зал за пульт ЭВМ.

Пакетный режим подразумевал, что подлежащие счету программы собираются в некоторый "пакет" (для ЭВМ первых поколений это
был деревянный или металлический ящик, наполненный программами, каждая программа была в отдельной пачке картонных
перфокарт, скрепленной резинками). Программистам, "отлучённым" от пульта ЭВМ, теперь приходилось вставлять в свои
программы многочисленные отладочные выдачи на печать. Анализируя потом эти выдачи, они пытались найти и исправить
ошибки, после чего опять отдавали свою программу на счёт.

Одним из принципов фон Неймана, как известно, является принцип последовательного выполнения команд программы. Более
того, архитектура машин фон Неймана предполагает, что последовательно выполняются не только команды текущей программы,
но также и сами эти программы. Другими словами, пока одна программа полностью не заканчивается, следующая программа не
загружается в память и не начинает выполняться. Именно так и работали первые ЭВМ (вспомните, как работала описанная
ранее учебная ЭВМ УМ-3). Сейчас познакомимся с весьма важным понятием – мультипрограммным (иногда говорят,
многопрограммным) режимом работы ЭВМ. Мультипрограммный режим работы означает, что в оперативной памяти компьютера
одновременно находятся несколько независимых друг от друга и готовых к счету программ пользователей, времена выполнения
которых могут перекрываться (Эти программы, вообще говоря, могут присутствовать в оперативной памяти не целиком.
Во-первых, они могут использовать изученную ранее схему динамической загрузки библиотек, и, во-вторых, работать на так
называемой виртуальной памяти, при этом некоторые части программы могут временно отсутствовать в оперативной памяти,
находясь в специальном файле подкачки (swap file) на внешней памяти.). Стоит также заметить, что при мультипрограммном
режиме работы в памяти ЭВМ одновременно могут находиться не только программы разных пользователей, но и несколько
независимых программ одного пользователя. Независимость программ означает, что они автоматически не обмениваются между
собой данными в процессе счета (через общие секции данных, файлы или как-нибудь ещё), т.е. они одновременно не решают
одну общую задачу.

Частично уже была обоснована необходимость присутствия в оперативной памяти нескольких программ, когда изучалась система
прерываний. Как правило, при возникновении прерывания процессор производит автоматическое переключение на некоторую
другую программу, которая тоже, конечно, должна при этом находиться в оперативной памяти. Здесь, однако, можно
возразить, что все программы, на которые производится автоматическое переключение при прерывании, являются системными
программами (входят в операционную систему), а при определении мультипрограммного режима работы особо подчеркивалось,
что в оперативной памяти могут одновременно находиться несколько разных программ обычных пользователей.

> На ЭВМ первых поколений "обычным" пользователям разрешалось писать свои собственные процедуры-обработчики прерываний,
> однако в операционных системах современных ЭВМ это, как правило, запрещено. Причина такого запрета будет понятна из
> дальнейшего изложения мультипрограммного режима работы ЭВМ. Вместо этого, программа пользователя может попросить
> операционную систему при возникновении исключительной ситуации в своей программе не вызывать стандартную процедуру ОС
> обработки этого события, а предварительно вызвать свою собственную процедуру, которая попытается сама разобраться в
> возникшей ошибке и попробует исправить её.

Следует указать две основные причины, по которым может понадобиться мультипрограммный режим работы. Во-первых, может
потребоваться одновременно выполнять несколько программ. Например, это могут быть программы, которые в диалоговом режиме
работают с разными пользователями (программисты Вася и Петя одновременно с разных терминалов (разных консолей),
подключенных к одной ЭВМ, отлаживают свои программы).

Правда, здесь имеет место уже упомянутая ранее трудность: так как процессор на компьютере может быть только один, то в
каждый момент времени может выполняться или программа Васи, или программа Пети (ну, или служебная программа операционной
системы при обработке прерывания). Эта трудность преодолевается введением специального режима работы ЭВМ – режима
разделения времени, который является частным случаем мультипрограммного режима (Во многих ОС режим разделения времени
называется режимом вытесняющей (preemptive) многозадачности. Имеется ввиду, что один процесс (задача) по истечению
кванта времени принудительно вытесняет(заменяет) процесс, выполняющийся в настоящее время. Более ранние ОС работали в
режиме не вытесняю-щей многозадачности, при этом новый процесс начинал выполняться, только если прежний добровольно
отдавал управление (например, ожидая ввода из файла) или заканчивался). В режиме разделения времени, используя сигналы
прерывания от встроенных в компьютер часов (таймера), служебная программа-диспетчер переключает процессор с одной задачи
пользователя на другую по истечении определенного кванта времени (time slice), обычно порядка единиц или десятков
миллисекунд. В таком режиме разделения времени (в русскоязычной литературе этот режим иногда метко называли коммунальным
использованием ресурсов ЭВМ) и у Васи, и у Пети создаётся иллюзия, что только его программа все время считается на
компьютере.

Другая причина широкого распространения мультипрограммного режима заключается в следующем. Наряду с главной частью –
процессором и оперативной памятью – в компьютере существует и большое количество так называемых периферийных (внешних)
устройств, это диски, клавиатура, мышь, печатающие устройства, сетевые карты и т.д. Все эти периферийные устройства
предназначены для связи центральной части машины с "внешним миром", и работают значительно медленнее, чем процессор и
оперативная память. Имеется в виду, что все они значительно медленнее манипулируют данными. Например, за то время, за
которое лазерный принтер напечатает на бумаге всего один символ, оперативная память способна выдать процессору миллионы
байт, а сам процессор способен за это время выполнить миллионы команд.

Из этих соображений, очевидно, что в то время, когда по запросу некоторой программы производится обмен данными с
медленными внешними устройствами, процессор, как правило, не сможет выполнять команды этой программы, т.е. будет
простаивать.

При описании языка высокого уровня обычно говориться, что при выполнении операции ввода/вывода вычислительный процесс
блокируется, т.е. переводится в состояние ожидания завершения этого ввода/вывода.

Вот здесь нам и пригодится способность программы-диспетчера переключаться на выполнение других программ пользователей,
тоже расположенных в оперативной памяти. Теперь, пока одна программа пользователя выполняет свои команды на центральном
процессоре, другая может выводить свои данные на принтер, третья – читать массив с диска в оперативную память, четвертая
– ждать ввода символа с клавиатуры и т.д. Правда, для того, чтобы обеспечить такую возможность, мало наличия на
компьютере одной системы прерываний. Прежде всего, необходимо научить периферийные устройства компьютера работать
параллельно и относительно независимо от центрального процессора. Действительно, вспомните, что в машине фон Неймана
всеми операциями с внешними устройствами управлял именно центральный процессор по командам ввода/вывода, посылая им
особые управляющие сигналы, которые изображались на схеме одинарными стрелками. Естественно, занимаясь этой работой (
т.е. выполняя команду ввода/вывода), центральный процессор уже не мог выполнять команды какой-либо другой программы.

## Требования к аппаратуре для обеспечения возможности работы в мультипрограммном режиме

Итак, сформулируем необходимые требования к аппаратуре ЭВМ для обеспечения возможности мультипрограммной работы. Надо
особо подчеркнуть, что это требования именно к аппаратуре ЭВМ, а не к её программному обеспечению.

Система прерываний. Система прерываний необходима как для режима разделения времени, так и для обеспечения параллельной
работы процессора и периферийных устройств, так как она обеспечивает саму возможность реакции на события и
автоматического переключения с одной программы на другую.

Механизм защиты памяти. Этот механизм обеспечивает безопасность одновременного нахождения в оперативной памяти
нескольких независимых программ. Защита памяти гарантирует, что одна программа не сможет случайно или же предумышленно
обратиться в память другой программы (по выполнению, по записи или даже по чтению данных). Очевидно, что без такого
механизма мультипрограммный режим просто невозможен. Даже если не принимать во внимание "вредных" программистов, которые
специально захотят испортить или незаконно прочитать данные других программ, всегда существует большая вероятность таких
действий из-за семантических ошибок в программах даже у "добропорядочных" программистов (например, при выходе индекса за
границу массива). Незаконное обращение к чужим ресурсам (в частности, к чужой оперативной памяти) "по-научному"
называется несанкционированным доступом.

Защита оперативной памяти на современных ЭВМ устроена весьма сложно, и часто связана с механизмом, так называемой (
сегментно-страничной) виртуальной памяти.

Аппарат привилегированных команд. Сейчас рассмотрим ещё одно необходимое свойство аппаратуры, без которого невозможно
реализовать мультипрограммный режим работы ЭВМ. Это свойство иногда называется аппаратом привилегированных команд, а
иногда – защищённым режимом работы процессора, и заключается оно в следующем: все команды, которые может выполнять
процессор, разбиваются на два класса. Команды из одного класса называются обычными командами или командами пользователя,
а команды из другого класса – привилегированными или запрещёнными командами.

Далее, в процессоре на каком-то регистре располагается признак режима работы (CPU mode). Значение этого признака и
определяет тот режим, в котором в данный момент работает процессор:обычный режим пользователя (user mode) или
привилегированный режим. Привилегированный режим часто называют режимом супервизора (supervisor mode) или режимом ядра
ОС (kernel mode). В архитектуре x86 текущий режим работы процессора обозначается CPL (Current Privilege Level), он
находится в двух младших битах селектора в сегментном регистре CS.

В привилегированном режиме процессору разрешается выполнять все команды языка машины, а в режиме пользователя – только
обычные (не привилегированные) команды. При попытке выполнить привилегированную команду в пользовательском режиме
процессором вырабатывается сигнал прерывания, а сама команда, естественно, не выполняется. Из этого правила выполнения
команд легко понять и другое название для привилегированных команд – запрещённые команды, так как их выполнение
запрещено в режиме пользователя. Объясним теперь, почему без аппарата привилегированных команд невозможно реализовать
мультипрограммный режим работы ЭВМ.

Привилегированными должны быть и все команды, которые обращаются к внешним (периферийным) устройствам. Например, нельзя
разрешать запись на диск в режиме пользователя, так как диск – это тоже общая память для всех программ, только внешняя,
и одна программа может испортить на диске данные (файлы), принадлежащие другим программам. То же самое относится и к
печатающему устройству: если разрешить всем программам бесконтрольно выводить свои данные на печать, то, конечно,
разобраться в том, что же получится на бумаге, будет чаще всего невозможно. Поэтому, если работающие в мультипрограммном
режиме программы Васи и Пети производят вывод на общий принтер, то на самом деле данные, которые печатает каждая
программа пользователя, не выводятся сразу на печать, а записываются в специальный файл, который обычно будет выводиться
на печать только после полного завершения этой программы. Таким образом, выводимые на печать данные Васи и Пети не
перепутаются.

Таймер. Встроенные в компьютер электронные часы (таймер) появились ещё до возникновения мультипрограммного режима
работы. Тем не менее легко понять, что без таймера мультипрограммный режим тоже невозможен. Действительно, это
единственное внешнее устройство, которое гарантированно и периодически посылает процессору сигналы прерываний. Без таких
сигналов некоторые программы могли бы войти в выполнение бесконечного цикла (зациклиться), и ничто не могло бы вывести
компьютер из этого состояния